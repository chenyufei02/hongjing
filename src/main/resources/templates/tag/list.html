<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">

<head>
    <th:block th:replace="~{layout :: common_head('标签管理', ~{})}" />
</head>

<body>

<div th:replace="~{layout :: navbar}"></div>
<div th:replace="~{layout :: sidebar(${activeUri})}"></div>

<div class="main-content">
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="h4">标签看板与组合查询</h2>
            <div>
                 <button id="refresh-all-tags-btn" class="btn btn-warning">一键刷新全量标签</button>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header fw-bold">
                高级组合查询
            </div>
            <div class="card-body">
                <p class="card-text text-muted">请在下方不同类别中选择一个或多个标签，然后点击“查询匹配的客户”按钮，系统将找出同时拥有您所选全部标签的客户群体。</p>
                <div id="combo-query-form" class="row g-3">
                    </div>
                <hr>
                <div class="d-flex justify-content-end align-items-center">
                     <button id="reset-query-btn" class="btn btn-outline-secondary me-2">重置选择</button>
                     <button id="submit-query-btn" class="btn btn-primary">查询匹配的客户</button>
                </div>
            </div>
        </div>


        <div class="card">
            <div class="card-header">
                标签统计总览 (点击下方标签可快速跳转到对应客户列表)
            </div>
            <div class="card-body">
                 <div th:if="${#maps.isEmpty(groupedTags)}" class="text-center p-4">
                    系统中暂无客户标签数据，请尝试点击右上角按钮进行刷新。
                </div>
                <div class="row" th:if="${not #maps.isEmpty(groupedTags)}">
                     <div th:each="entry : ${groupedTags}" th:if="${not #lists.isEmpty(entry.value)}"
                     th:class="${entry.key == '职业'} ? 'col-md-12 mb-4' : 'col-md-6 mb-4'">
                        <div class="card h-100">
                            <div class="card-header fw-bold" th:text="${entry.key}"></div>
                            <div class="card-body">
                                <a th:each="tag : ${entry.value}"
                                        class="btn btn-outline-secondary btn-sm m-1"
                                        th:href="@{/customer/list(tagName=${tag.tagName})}"
                                        th:text="${tag.tagName} + ' (' + ${tag.customerCount} + '人)'">
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto" id="toast-title">系统通知</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toast-body"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    /* <![CDATA[ */
    document.addEventListener('DOMContentLoaded', function() {
        const groupedTags = /*[[${groupedTags}]]*/ {};
        const formContainer = document.getElementById('combo-query-form');
        const submitBtn = document.getElementById('submit-query-btn');
        const resetBtn = document.getElementById('reset-query-btn');

        // --- 核心逻辑：动态生成所有下拉框 ---
        for (const category in groupedTags) {
            if (groupedTags.hasOwnProperty(category) && groupedTags[category].length > 0) {
                const col = document.createElement('div');
                col.className = 'col-md-3';
                const select = document.createElement('select');
                select.className = 'form-select combo-select';
                // 为每个下拉框创建一个唯一的ID，例如 'select-职业'
                select.id = 'select-' + category;
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '选择 ' + category + '...';
                select.appendChild(defaultOption);

                groupedTags[category].forEach(tag => {
                    const option = document.createElement('option');
                    option.value = tag.tagName;
                    option.textContent = tag.tagName;
                    select.appendChild(option);
                });
                col.appendChild(select);
                formContainer.appendChild(col);
            }
        }

        // --- “高级查询”面板的按钮事件监听 ---
        resetBtn.addEventListener('click', function() {
            document.querySelectorAll('.combo-select').forEach(select => select.value = '');
        });

        submitBtn.addEventListener('click', function() {
            const selectedTags = [];
            document.querySelectorAll('.combo-select').forEach(select => {
                if (select.value) {
                    selectedTags.push(select.value);
                }
            });
            if (selectedTags.length === 0) {
                alert('请至少选择一个标签进行组合查询！');
                return;
            }
            const tagNameQuery = selectedTags.join(',');
            const targetUrl = /*[[@{/customer/list}]]*/ '/customer/list' + '?tagName=' + encodeURIComponent(tagNameQuery);
            window.location.href = targetUrl;
        });


        // --- “一键刷新”的Toast和全量刷新逻辑 ---
        const refreshBtn = document.getElementById('refresh-all-tags-btn');
        const toastElement = document.getElementById('liveToast');
        const toast = new bootstrap.Toast(toastElement);
        const toastTitle = document.getElementById('toast-title');
        const toastBody = document.getElementById('toast-body');

        if(refreshBtn) {
            refreshBtn.addEventListener('click', function() {
                if (!confirm('这将为所有客户重新计算画像标签...')) return;
                toastTitle.textContent = '⏳ 任务启动中...';
                toastBody.textContent = '已向后台发送全量标签刷新指令。';
                toastElement.className = 'toast text-bg-primary';
                toast.show();
                fetch('/tags/refresh-all', { method: 'POST' })
                    .then(r => r.json()).then(d => { if(!d.success) throw new Error(d.message); }).catch(e => {
                        toastTitle.textContent = '❌ 启动失败';
                        toastBody.textContent = e.message;
                        toastElement.className = 'toast text-bg-danger';
                        toast.show();
                });
            });
        }
    });
    /* ]]> */
</script>

</body>
</html>