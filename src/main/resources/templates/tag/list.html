<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">

<head>
    <th:block th:replace="~{layout :: common_head('标签管理', ~{})}" />
</head>

<body>

<div th:replace="~{layout :: navbar}"></div>
<div th:replace="~{layout :: sidebar(${activeUri})}"></div>

<div class="main-content">
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="h4">标签看板与组合查询</h2>
            <div>
                 <button id="refresh-all-tags-btn" class="btn btn-warning">一键刷新全量标签</button>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header fw-bold">
                高级组合查询
            </div>
            <div class="card-body">
                <p class="card-text text-muted">请在下方不同类别中选择一个或多个标签，然后点击“查询匹配的客户”按钮，系统将找出同时拥有您所选全部标签的客户群体。</p>
                <div id="combo-query-form" class="row g-3"></div>
                <hr>
                <div class="d-flex justify-content-end align-items-center">
                     <button id="reset-query-btn" class="btn btn-outline-secondary me-2">重置选择</button>
                     <button id="submit-query-btn" class="btn btn-primary">查询匹配的客户</button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                标签统计总览 (点击下方标签可快速跳转到对应客户列表)
            </div>
            <div class="card-body">
                 <div th:if="${#maps.isEmpty(groupedTags)}" class="text-center p-4">
                    系统中暂无客户标签数据，请尝试点击右上角按钮进行刷新。
                </div>
                <div class="row" th:if="${not #maps.isEmpty(groupedTags)}">
                     <div th:each="entry : ${groupedTags}" th:if="${not #lists.isEmpty(entry.value)}"
                     th:class="${entry.key == '职业'} ? 'col-md-12 mb-4' : 'col-md-6 mb-4'">
                        <div class="card h-100">
                            <div class="card-header fw-bold" th:text="${entry.key}"></div>
                            <div class="card-body">
                                <a th:each="tag : ${entry.value}"
                                        class="btn btn-outline-secondary btn-sm m-1"
                                        th:href="@{/customer/list(tagName=${tag.tagName})}"
                                        th:text="${tag.tagName} + ' (' + ${tag.customerCount} + '人)'">
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="tag-data-container" style="display: none;" th:data-json="${groupedTagsJson}"></div>

<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto" id="toast-title">系统通知</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toast-body"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    try {
        // --- 高级组合查询的逻辑 (保持不变) ---
        const dataContainer = document.getElementById('tag-data-container');
        const jsonString = dataContainer.getAttribute('data-json');
        const groupedTags = JSON.parse(jsonString);
        const formContainer = document.getElementById('combo-query-form');
        const submitBtn = document.getElementById('submit-query-btn');
        const resetBtn = document.getElementById('reset-query-btn');

        for (const category in groupedTags) {
            if (groupedTags.hasOwnProperty(category) && groupedTags[category].length > 0) {
                const col = document.createElement('div');
                col.className = 'col-md-3';
                const select = document.createElement('select');
                select.className = 'form-select combo-select';
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '选择 ' + category + '...';
                select.appendChild(defaultOption);
                groupedTags[category].forEach(tag => {
                    const option = document.createElement('option');
                    option.value = tag.tagName;
                    option.textContent = tag.tagName;
                    select.appendChild(option);
                });
                col.appendChild(select);
                formContainer.appendChild(col);
            }
        }

        // 为“重置选择”按钮添加逻辑
        resetBtn.addEventListener('click', function() {
            document.querySelectorAll('.combo-select').forEach(select => {
                select.value = '';
            });
        });

        // 为“查询匹配的客户”按钮补全逻辑
        submitBtn.addEventListener('click', function() {
            // 1. 收集所有下拉框中被选中的、非空的标签值
            const selectedTags = [];
            document.querySelectorAll('.combo-select').forEach(select => {
                if (select.value) {
                    selectedTags.push(select.value);
                }
            });

            // 如果没有选择任何标签，则不执行任何操作
            if (selectedTags.length === 0) {
                alert('请至少选择一个标签进行查询。');
                return;
            }

            // 2. 将标签列表用【逗号】拼接成一个字符串
            //    注意：这里的分隔符必须和 CustomerServiceImpl 中 .split() 使用的分隔符一致！
            const tagNameQuery = selectedTags.join(',');

            // 3. 构建最终的URL并跳转到客户列表页
            const targetUrl = `/customer/list?tagName=${encodeURIComponent(tagNameQuery)}`;
            window.location.href = targetUrl;
        });

        // --- 【 一键刷新 】 ---
        const refreshBtn = document.getElementById('refresh-all-tags-btn');
        const toastElement = document.getElementById('liveToast');
        const toast = new bootstrap.Toast(toastElement);
        const toastTitle = document.getElementById('toast-title');
        const toastBody = document.getElementById('toast-body');

        if (refreshBtn) {
            refreshBtn.addEventListener('click', function() {
                if (!confirm('这将为所有客户重新计算画像标签，过程可能需要一段时间，期间请勿关闭页面。确定要开始吗？')) {
                    return;
                }

                // 1. 禁用按钮，防止重复点击，并显示“正在刷新”的初始提示
                refreshBtn.disabled = true;
                refreshBtn.textContent = '正在刷新...';
                toastTitle.textContent = '⏳ 刷新中...';
                toastBody.textContent = '已向后台发送刷新指令，请耐心等待任务完成...';
                toastElement.className = 'toast text-bg-info';
                toast.show();

                // 2. 发起一个可能会长时间等待的请求
                fetch('/api/tags/refresh-all', { method: 'POST' })
                    .then(response => {
                        if (!response.ok) { // 处理网络或服务器错误
                            return response.json().then(err => Promise.reject(err));
                        }
                        return response.json(); // 解析JSON响应体
                    })
                    .then(data => {
                        // 3. 请求成功完成
                        if (data.success) {
                            // 使用后端返回的“已完成”消息，弹出成功提示
                            toastTitle.textContent = '✅ 刷新成功';
                            toastBody.textContent = data.message;
                            toastElement.className = 'toast text-bg-success';
                            toast.show();
                            // 2秒后自动刷新页面，以展示最新的标签数据
                            setTimeout(() => window.location.reload(), 2000);
                        } else {
                            // 后端执行出错，抛出错误
                            throw new Error(data.message);
                        }
                    })
                    .catch(error => {
                        // 4. 捕获任何阶段发生的错误，并弹出失败提示
                        console.error('刷新全量标签时发生错误:', error);
                        toastTitle.textContent = '❌ 刷新失败';
                        toastBody.textContent = error.message || '发生未知网络或服务器错误。';
                        toastElement.className = 'toast text-bg-danger';
                        toast.show();
                    })
                    .finally(() => {
                        // 5. 无论成功或失败，最后都恢复按钮状态
                        refreshBtn.disabled = false;
                        refreshBtn.textContent = '一键刷新全量标签';
                    });
            });
        }

    } catch (e) {
        console.error("脚本执行时发生严重错误:", e);
        alert("页面脚本发生错误，请按F12打开开发者控制台查看详情。");
    }
});
</script>

</body>
</html>