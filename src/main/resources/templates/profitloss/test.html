<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">

<head>
    <th:block th:replace="~{layout :: common_head('客户详情', ~{})}" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        .metric-card { border-left-width: 4px; border-radius: .35rem; }
        .metric-card .card-body { padding: 1.5rem; }
        .metric-card-profit { border-left-color: #d32f2f; }
        .metric-card-loss { border-left-color: #388e3c; }
        .metric-card-neutral { border-left-color: #0d6efd; }
        .metric-card-asset { border-left-color: #ffc107; }

        .text-profit { color: #d32f2f; }
        .text-loss { color: #388e3c; }

        .tag-badge { color: #fff; background-color: #6c757d; margin: 0 8px 8px 0; padding: 0.5em 0.75em; font-size: 0.9rem; font-weight: 500; display: inline-block;}
        .tag-cat-asset { background-color: #ffb300; color: #000; }
        .tag-cat-style { background-color: #0d47a1; }
        .tag-cat-recency { background-color: #00897b; }
        .tag-cat-frequency { background-color: #00acc1; }
        .tag-cat-gender, .tag-cat-occupation, .tag-cat-age { background-color: #546e7a; }
        .tag-cat-risk-declared { background-color: #5e35b1; }
        .tag-cat-risk-actual { background-color: #fb8c00; }
        .tag-cat-risk-diagnosis-match { background-color: #43a047; }
        .tag-cat-risk-diagnosis-overweight { background-color: #e53935; }
        .tag-cat-risk-diagnosis-underweight { background-color: #1e88e5; }

        .tag-group-title { font-weight: 600; color: #666; margin-bottom: 0.75rem; font-size: 0.9rem; text-transform: uppercase; letter-spacing: .5px;}
    </style>
</head>

<body>

<div th:replace="~{layout :: navbar}"></div>
<div th:replace="~{layout :: sidebar(${activeUri})}"></div>

<div class="main-content">
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="h4">客户详情</h2>
            <a th:href="${backUrl}" class="btn btn-secondary">返回列表</a>
        </div>

        <div class="row">
            <div class="col-lg-5 mb-4">
                <div class="card h-100">
                    <div class="card-header fw-bold"><i class="bi bi-person-lines-fill me-2"></i>基础信息</div>
                    <div class="card-body">
                        <div class="row" th:object="${customer}">
                            <div class="col-md-6 mb-3"><strong>客户ID:</strong> <span th:text="*{id}"></span></div>
                            <div class="col-md-6 mb-3"><strong>姓名:</strong> <span th:text="*{name}"></span></div>
                            <div class="col-md-6 mb-3"><strong>性别:</strong> <span th:text="*{gender}"></span></div>
                            <div class="col-md-6 mb-3"><strong>出生日期:</strong> <span th:text="*{birthDate}"></span></div>
                            <div class="col-md-12 mb-3"><strong>证件号码:</strong> <span th:text="*{idNumber}"></span></div>
                            <div class="col-md-6 mb-3"><strong>职业:</strong> <span th:text="*{occupation}"></span></div>
                            <div class="col-md-6 mb-3"><strong>手机号:</strong> <span th:text="*{phone}"></span></div>
                            <div class="col-md-12"><strong>联系地址:</strong> <span th:text="*{address}"></span></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-7 mb-4">
                <div class="card h-100">
                    <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-tags-fill me-2"></i>画像标签云</span>
                        <button class="btn btn-warning btn-sm" id="refresh-single-tag-btn" th:data-customer-id="${customer.id}">
                            <i class="bi bi-arrow-clockwise"></i> 刷新标签
                        </button>
                    </div>
                     <div class="card-body p-4">
                        <div class="row mb-3">
                            <div class="col-md-4 border-end"><h6 class="tag-group-title">基础画像</h6><span th:each="tag : ${basicProfileTags}" class="badge tag-badge" th:text="${tag.tagName}" th:classappend="${tag.tagCategory == T(com.whu.hongjing.constants.TaggingConstants).CATEGORY_GENDER ? 'tag-cat-gender' : (tag.tagCategory == T(com.whu.hongjing.constants.TaggingConstants).CATEGORY_OCCUPATION ? 'tag-cat-occupation' : 'tag-cat-age')}"></span></div>
                            <div class="col-md-4 border-end"><h6 class="tag-group-title">资产规模</h6><span th:each="tag : ${assetTags}" class="badge tag-badge" th:text="${tag.tagName}" th:classappend="'tag-cat-asset'"></span></div>
                            <div class="col-md-4"><h6 class="tag-group-title">投资风格</h6><span th:each="tag : ${styleTags}" class="badge tag-badge" th:text="${tag.tagName}" th:classappend="'tag-cat-style'"></span></div>
                        </div>
                        <hr class="my-3">
                        <div class="row">
                            <div class="col-md-6 border-end"><h6 class="tag-group-title">交易习惯</h6><span th:each="tag : ${tradingHabitTags}" class="badge tag-badge" th:text="${tag.tagName}" th:classappend="${tag.tagCategory == T(com.whu.hongjing.constants.TaggingConstants).CATEGORY_RECENCY ? 'tag-cat-recency' : 'tag-cat-frequency'}"></span></div>
                            <div class="col-md-6"><h6 class="tag-group-title">风险状况</h6><span th:each="tag : ${riskProfileTags}" class="badge tag-badge" th:text="${tag.tagName}" th:classappend="${tag.tagCategory == T(com.whu.hongjing.constants.TaggingConstants).CATEGORY_RISK_DECLARED ? 'tag-cat-risk-declared' : (tag.tagCategory == T(com.whu.hongjing.constants.TaggingConstants).CATEGORY_RISK_ACTUAL ? 'tag-cat-risk-actual' : (tag.tagName == T(com.whu.hongjing.constants.TaggingConstants).LABEL_DIAGNOSIS_MATCH ? 'tag-cat-risk-diagnosis-match' : (tag.tagName == T(com.whu.hongjing.constants.TaggingConstants).LABEL_DIAGNOSIS_OVERWEIGHT ? 'tag-cat-risk-diagnosis-overweight' : 'tag-cat-risk-diagnosis-underweight')))}"></span></div>
                        </div>
                     </div>
                </div>
            </div>
        </div>

        <div class="row mt-2" th:if="${stats != null}">
            <div class="col-xl-3 col-md-6 mb-4"><div class="card metric-card metric-card-asset shadow h-100"><div class="card-body"><div class="row no-gutters align-items-center"><div class="col mr-2"><div class="text-xs font-weight-bold text-warning text-uppercase mb-1">当前总资产</div><div class="h5 mb-0 font-weight-bold text-gray-800" th:text="${#numbers.formatDecimal(stats.totalMarketValue, 1, 'COMMA', 2, 'POINT')} + ' 元'"></div></div><div class="col-auto"><i class="bi bi-wallet2 fs-2 text-gray-300"></i></div></div></div></div></div>
            <div class="col-xl-3 col-md-6 mb-4"><div class="card metric-card metric-card-neutral shadow h-100"><div class="card-body"><div class="row no-gutters align-items-center"><div class="col mr-2"><div class="text-xs font-weight-bold text-primary text-uppercase mb-1">累计总投资</div><div class="h5 mb-0 font-weight-bold text-gray-800" th:text="${#numbers.formatDecimal(stats.totalInvestment, 1, 'COMMA', 2, 'POINT')} + ' 元'"></div></div><div class="col-auto"><i class="bi bi-piggy-bank-fill fs-2 text-gray-300"></i></div></div></div></div></div>
            <div class="col-xl-3 col-md-6 mb-4"><div class="card metric-card shadow h-100" th:classappend="${stats.totalProfitLoss >= 0 ? 'metric-card-profit' : 'metric-card-loss'}"><div class="card-body"><div class="row no-gutters align-items-center"><div class="col mr-2"><div class="text-xs font-weight-bold text-uppercase mb-1" th:classappend="${stats.totalProfitLoss >= 0 ? 'text-danger' : 'text-success'}">累计总盈亏</div><div class="h5 mb-0 font-weight-bold" th:classappend="${stats.totalProfitLoss >= 0 ? 'text-profit' : 'text-loss'}" th:text="${(stats.totalProfitLoss >= 0 ? '+' : '') + #numbers.formatDecimal(stats.totalProfitLoss, 1, 'COMMA', 2, 'POINT')} + ' 元'"></div></div><div class="col-auto"><i class="bi fs-2 text-gray-300" th:classappend="${stats.totalProfitLoss >= 0 ? 'bi-graph-up-arrow' : 'bi-graph-down-arrow'}"></i></div></div></div></div></div>
            <div class="col-xl-3 col-md-6 mb-4"><div class="card metric-card shadow h-100" th:classappend="${stats.profitLossRate >= 0 ? 'metric-card-profit' : 'metric-card-loss'}"><div class="card-body"><div class="row no-gutters align-items-center"><div class="col mr-2"><div class="text-xs font-weight-bold text-uppercase mb-1" th:classappend="${stats.profitLossRate >= 0 ? 'text-danger' : 'text-success'}">总盈亏率</div><div class="h5 mb-0 font-weight-bold" th:classappend="${stats.profitLossRate >= 0 ? 'text-profit' : 'text-loss'}" th:text="${(stats.profitLossRate >= 0 ? '+' : '') + #numbers.formatDecimal(stats.profitLossRate, 1, 2, 'POINT')} + '%'"></div></div><div class="col-auto"><i class="bi bi-reception-4 fs-2 text-gray-300"></i></div></div></div></div></div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header fw-bold"><i class="bi bi-pie-chart-fill me-2"></i>投资分析图表</div>
                    <div class="card-body p-4">
                        <div th:if="${assetAllocationJson == '{}'}" class="text-muted text-center py-5"><p>客户暂无有效持仓数据，无法生成投资分析图表。</p></div>
                        <div th:unless="${assetAllocationJson == '{}'}" class="row">
                            <div class="col-md-4 text-center"><h6 class="text-muted mb-3">资产类别分布 <i class="bi bi-info-circle-fill text-muted" style="cursor: pointer;" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-placement="top" data-bs-title="资产类别分布说明" th:data-bs-content="'该图表展示了客户当前总资产在不同基金类型之间的<b>构成比例</b>。'"></i></h6><div style="height: 300px;"><canvas id="doughnutChart"></canvas></div></div>
                            <div class="col-md-4 text-center border-start border-end"><h6 class="text-muted mb-3">资产配置详情 <i class="bi bi-info-circle-fill text-muted" style="cursor: pointer;" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-placement="top" data-bs-title="资产配置详情说明" th:data-bs-content="'该雷达图展示了各类资产的<b>绝对市值</b>，用于直观感受客户在哪个方向上“下注”最重。'"></i></h6><div style="height: 300px;"><canvas id="assetRadarChart"></canvas></div></div>
                            <div class="col-md-4 text-center"><h6 class="text-muted mb-3">多维风险洞察 <i class="bi bi-info-circle-fill text-muted" style="cursor: pointer;" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-placement="top" data-bs-title="多维风险洞察说明" th:data-bs-content="'这是一个高级风险分析模型，所有维度<b>得分越高，代表风险或激进程度越高</b>。<ul><li><b>风险暴露度</b>: 衡量投入风险市场的资金比例。</li><li><b>投资进攻性</b>: 衡量在投资品中，选择了多少高风险品种。</li><li><b>持仓集中度</b>: 衡量是否存在“把鸡蛋放一个篮子”的风险。</li><li><b>行为激进程度</b>: 衡量客户的实际操作是否比其自述的更激进。</li><li><b>流动性风险</b>: 衡量客户的现金储备情况，值越高代表现金越少。</li></ul>'"></i></h6><div style="height: 300px;"><canvas id="riskRadarChart"></canvas></div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12"><div class="card"><div class="card-header fw-bold"><i class="bi bi-graph-up me-2"></i>历史走势分析</div><div class="card-body" style="min-height: 300px;"><p class="text-muted text-center pt-5">历史走势图模块即将上线...</p></div></div></div>
        </div>
    </div>
</div>

<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header"><strong class="me-auto" id="toast-title"></strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button></div>
        <div class="toast-body" id="toast-body"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

<script th:inline="javascript">
/* <![CDATA[ */
document.addEventListener('DOMContentLoaded', function() {
    // 激活 Popovers
    const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]');
    [...popoverTriggerList].map(popoverTriggerEl => new bootstrap.Popover(popoverTriggerEl, { sanitize: false, html: true }));

    // 刷新按钮逻辑
    const refreshBtn = document.getElementById('refresh-single-tag-btn');
    if (refreshBtn) {
        const toastElement = document.getElementById('liveToast');
        const toast = new bootstrap.Toast(toastElement);
        const toastTitle = document.getElementById('toast-title');
        const toastBody = document.getElementById('toast-body');

        refreshBtn.addEventListener('click', function() {
            const customerId = this.dataset.customerId;
            if (!confirm('确定要为客户ID: ' + customerId + ' 重新生成所有画像标签吗？')) return;

            refreshBtn.disabled = true;
            refreshBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 刷新中...';

            fetch('/api/tags/refresh/' + customerId, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        toastTitle.textContent = '✅ 刷新成功';
                        toastBody.textContent = data.message + ' 页面即将自动刷新...';
                        toastElement.className = 'toast text-bg-success';
                        toast.show();
                        setTimeout(() => window.location.reload(), 2000);
                    } else {
                        throw new Error(data.message);
                    }
                })
                .catch(error => {
                    toastTitle.textContent = '❌ 刷新失败';
                    toastBody.textContent = error.message;
                    toastElement.className = 'toast text-bg-danger';
                    toast.show();
                    refreshBtn.disabled = false;
                    refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> 刷新标签';
                });
        });
    }

    // 图表渲染逻辑
    const assetJson = /*[[${assetAllocationJson}]]*/ '{}';
    const riskJson = /*[[${riskInsightJson}]]*/ '{}';
    const colorMapJson = /*[[${colorMapJson}]]*/ '{}';

    Chart.register(ChartDataLabels);

    if (assetJson && assetJson !== '{}') {
        try {
            const data = JSON.parse(assetJson);
            const colorMap = JSON.parse(colorMapJson);
            const labels = Object.keys(data);
            const values = Object.values(data);
            const backgroundColors = labels.map(label => colorMap[label] || '#cccccc');

            new Chart(document.getElementById('doughnutChart'), {
                type: 'doughnut',
                data: { labels: labels, datasets: [{ data: values, backgroundColor: backgroundColors, borderColor: '#fff', borderWidth: 2 }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { boxWidth: 12, padding: 15 } },
                        datalabels: {
                            formatter: (value, ctx) => {
                                let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                let percentage = (value * 100 / sum).toFixed(1) + '%';
                                return percentage;
                            },
                            color: '#fff', font: { weight: 'bold', size: 12 }
                        }
                    }
                }
            });

            new Chart(document.getElementById('assetRadarChart'), {
                type: 'radar', data: { labels: labels, datasets: [{ label: '市值', data: values, fill: true, backgroundColor: 'rgba(255, 99, 132, 0.2)', borderColor: 'rgb(255, 99, 132)' }] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        // 关键：完全移除 datalabels 插件的配置
                        datalabels: {
                            display: false // 明确禁用
                        }
                    }
                }
            });
        } catch (e) { console.error("渲染资产图表时出错:", e); }
    }

    if (riskJson && riskJson !== '{}') {
        try {
            const data = JSON.parse(riskJson);
            new Chart(document.getElementById('riskRadarChart'), {
                type: 'radar', data: { labels: Object.keys(data), datasets: [{ label: '得分(%)', data: Object.values(data), fill: true, backgroundColor: 'rgba(54, 162, 235, 0.2)', borderColor: 'rgb(54, 162, 235)' }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { r: { suggestedMin: 0, suggestedMax: 100, pointLabels: { font: { size: 11 } } } }, plugins: { legend: { display: false } } }
            });
        } catch (e) { console.error("渲染风险图表时出错:", e); }
    }
});
/* ]]> */
</script>

</body>
</html>