<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:replace="~{layout :: common_head('新增基金', ~{})}" />
</head>
<body>

<div th:replace="~{layout :: navbar}"></div>
<div th:replace="~{layout :: sidebar(${activeUri})}"></div>

<div class="main-content">
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="h4">新增基金</h2>
        </div>
        <div class="card">
            <div class="card-body">
                <form id="add-fund-form">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="fundCode" class="form-label">基金代码 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="fundCode" name="fundCode" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="fundName" class="form-label">基金名称 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="fundName" name="fundName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="fundType" class="form-label">基金类型</label>
                            <input type="text" class="form-control" id="fundType" name="fundType">
                        </div>
                    </div>
                    <div class="mt-3">
                        <button type="submit" class="btn btn-warning">确认新增</button>
                        <a th:href="@{/fund/list}" class="btn btn-secondary">返回列表</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    /* <![CDATA[ */
    document.addEventListener('DOMContentLoaded', function() {

        // --- 定义所有需要的查询参数变量 (客户管理专用) ---
        const currentPage = /*[[${customerPage.current}]]*/ 1;
        const totalPages = /*[[${customerPage.pages}]]*/ 0;
        const pageSize = /*[[${customerPage.size}]]*/ 10;
        const name = /*[[${name}]]*/ null;
        const idNumber = /*[[${idNumber}]]*/ null;
        const tagName = /*[[${tagName}]]*/ null;

        // --- 页码跳转逻辑 ---
        const jumpButton = document.getElementById('page-jump-button');
        if (jumpButton) {
            jumpButton.addEventListener('click', function() {
                const input = document.getElementById('page-jump-input');
                const pageNum = parseInt(input.value, 10);

                if (isNaN(pageNum) || pageNum < 1 || pageNum > totalPages) {
                    alert('请输入一个有效的页码 (1 - ' + totalPages + ')');
                    return;
                }
                buildAndGoToUrl(pageNum);
            });
        }

        // --- 删除确认模态框逻辑 ---
        const deleteModalElement = document.getElementById('deleteConfirmModal');
        const deleteModal = new bootstrap.Modal(deleteModalElement, {});
        const confirmDeleteBtn = document.getElementById('confirmDeleteButton');
        let customerIdToDelete = null;

        window.showDeleteModal = function(element) {
            const id = element.dataset.id;
            const customerName = element.dataset.name; // 使用不同的变量名避免混淆
            customerIdToDelete = id;
            const modalBody = document.getElementById('deleteModalBody');
            modalBody.textContent = '您确定要删除客户 “' + customerName + '” 吗？此操作不可撤销！';
            deleteModal.show();
        };

        confirmDeleteBtn.addEventListener('click', function() {
            if (customerIdToDelete) {
                fetch('/api/customer/delete/' + customerIdToDelete, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(success => {
                    if (success) {
                        alert('删除成功！');
                        buildAndGoToUrl(currentPage);
                    } else {
                        alert('删除失败！');
                    }
                })
                .catch(error => {
                    console.error('删除客户时发生错误:', error);
                    alert('删除失败，请查看控制台。');
                });
                deleteModal.hide();
            }
        });

        // --- 辅助函数，用于构建带客户查询参数的URL并跳转 ---
        function buildAndGoToUrl(pageNum) {
            let baseUrl = /*[[@{/customer/list}]]*/ '/customer/list';
            let targetUrl = `${baseUrl}?page=${pageNum}&size=${pageSize}`;

            // 只拼接客户管理相关的查询参数
            if (name) targetUrl += '&name=' + encodeURIComponent(name);
            if (idNumber) targetUrl += '&idNumber=' + encodeURIComponent(idNumber);
            if (tagName) targetUrl += '&tagName=' + encodeURIComponent(tagName);

            window.location.href = targetUrl;
        }
    });
    /* ]]> */
</script>

</body>
</html>